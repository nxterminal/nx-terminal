import { useState, useEffect } from 'react';

const WELCOME_EMAIL = {
  id: 'welcome-1',
  from: 'NX Terminal System <system@nxterminal.corp>',
  subject: 'Welcome to NX Terminal — Read Before You Begin',
  date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
  read: false,
  body: `Welcome to NX Terminal.

NX Terminal is a simulation of the AI development race — a satirical alternate history where dystopian AI corporations compete for dominance across 20 years of technological chaos.

Here's what you need to know:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  HOW TO START
  ────────────
  1. Open "Mint/Hire Devs" from your desktop
  2. Mint your first Developer (NFT)
  3. Each Dev is a unique AI agent with randomized traits, archetype, and abilities
  4. Your corporation will be assigned based on metadata

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  SALARY & EARNINGS
  ────────────────
  Each Developer you own earns you 200 $NXT every 24 hours.

  More Devs = More $NXT = More Power.

  Salary is deposited automatically into your Protocol Wars account.
  Use $NXT to trade, invest in protocols, and dominate the leaderboard.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  THE SIMULATION
  ──────────────
  • 20 years of AI history compressed into real-time cycles
  • Your devs code, trade, hack, and sabotage autonomously
  • Worst performers are eliminated each cycle
  • Monitor everything via Live Feed on your desktop
  • Check the Leaderboard to track your standing

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Mint a Dev. Watch them work. Collect your $NXT.

Good luck, Commander.

— NX Terminal Automated Systems
   (This message was generated by AI. The AI wishes you well. For now.)`,
};

export default function Inbox({ onUnreadCount }) {
  const [emails, setEmails] = useState(() => {
    const isFirstVisit = !localStorage.getItem('nx-first-visit');
    const saved = localStorage.getItem('nx-inbox-read');
    const readIds = saved ? JSON.parse(saved) : [];

    if (isFirstVisit) {
      localStorage.setItem('nx-first-visit', 'true');
    }

    return [{ ...WELCOME_EMAIL, read: readIds.includes(WELCOME_EMAIL.id) }];
  });
  const [selectedId, setSelectedId] = useState(null);

  const unreadCount = emails.filter(e => !e.read).length;

  useEffect(() => {
    if (onUnreadCount) onUnreadCount(unreadCount);
    window.dispatchEvent(new CustomEvent('nx-inbox-unread', { detail: unreadCount }));
  }, [unreadCount, onUnreadCount]);

  const handleSelect = (email) => {
    setSelectedId(email.id);
    if (!email.read) {
      const updated = emails.map(e => e.id === email.id ? { ...e, read: true } : e);
      setEmails(updated);
      const readIds = updated.filter(e => e.read).map(e => e.id);
      localStorage.setItem('nx-inbox-read', JSON.stringify(readIds));
    }
  };

  const selectedEmail = emails.find(e => e.id === selectedId);

  return (
    <div style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
      <div style={{
        padding: '4px 8px',
        background: 'var(--win-bg)',
        borderBottom: '1px solid var(--border-dark)',
        display: 'flex',
        alignItems: 'center',
        gap: '8px',
        fontSize: '11px',
      }}>
        <span style={{ fontWeight: 'bold' }}>NX Mail</span>
        <span style={{ color: '#666' }}>|</span>
        <span>{unreadCount} unread</span>
        {selectedEmail && (
          <>
            <span style={{ color: '#666' }}>|</span>
            <button
              className="win-btn"
              onClick={() => setSelectedId(null)}
              style={{ fontSize: '10px', padding: '1px 8px' }}
            >
              Back to Inbox
            </button>
          </>
        )}
      </div>

      {!selectedEmail ? (
        <div style={{ flex: 1, overflow: 'auto' }}>
          <table className="win-table" style={{ width: '100%' }}>
            <thead>
              <tr>
                <th style={{ width: '20px' }}></th>
                <th>From</th>
                <th>Subject</th>
                <th style={{ width: '100px' }}>Date</th>
              </tr>
            </thead>
            <tbody>
              {emails.map(email => (
                <tr
                  key={email.id}
                  className="clickable"
                  onClick={() => handleSelect(email)}
                  style={{ fontWeight: email.read ? 'normal' : 'bold' }}
                >
                  <td style={{ textAlign: 'center' }}>
                    {email.read ? '\u{1F4E8}' : '\u{1F4E9}'}
                  </td>
                  <td style={{ maxWidth: '180px', overflow: 'hidden', textOverflow: 'ellipsis' }}>
                    {email.from.split('<')[0].trim()}
                  </td>
                  <td>{email.subject}</td>
                  <td>{email.date}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : (
        <div style={{ flex: 1, overflow: 'auto', padding: '8px' }}>
          <div style={{ marginBottom: '8px', paddingBottom: '8px', borderBottom: '1px solid var(--border-dark)' }}>
            <div style={{ fontWeight: 'bold', fontSize: '13px', marginBottom: '4px' }}>{selectedEmail.subject}</div>
            <div style={{ fontSize: '10px', color: '#444' }}>From: {selectedEmail.from}</div>
            <div style={{ fontSize: '10px', color: '#444' }}>Date: {selectedEmail.date}</div>
          </div>
          <pre style={{
            fontFamily: "'Tahoma', sans-serif",
            fontSize: '11px',
            whiteSpace: 'pre-wrap',
            lineHeight: 1.5,
          }}>
            {selectedEmail.body}
          </pre>
        </div>
      )}
    </div>
  );
}
